<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ようりょうくん - 小児薬用量計算ツール</title>
    <meta name="description" content="薬剤師のための小児薬用量計算ツール「ようりょうくん」。簡単・正確・安全に小児の投与量を計算できます。">
    <meta name="theme-color" content="#4CAF50">
    <link rel="manifest" href="manifest.json">
    <style>
        /* ベーススタイル */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 15px;
            line-height: 1.6;
            color: #333;
            background-color: #f7fafd;
            -webkit-text-size-adjust: 100%;
            -webkit-font-smoothing: antialiased;
        }
        .form-group {
            margin-bottom: 25px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            font-size: 20px;
        }
        select, input, button {
            width: 100%;
            height: 60px;
            padding: 16px 20px;
            font-size: 20px;
            margin-bottom: 20px;
            border: 2px solid #ddd;
            border-radius: 8px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-color: #fff;
            box-sizing: border-box;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            font-size: 22px;
            padding: 18px 20px;
            margin-top: 10px;
            transition: background-color 0.3s;
            -webkit-tap-highlight-color: rgba(0,0,0,0);
        }
        
        button:active {
            background: #3d8b40;
            transform: translateY(1px);
        }
        button:hover {
            background: #45a049;
        }
        #result {
            margin-top: 25px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: #f9f9f9;
            display: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        #result h3 {
            margin-top: 0;
            color: #2c3e50;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }
        
        h1 {
            text-align: center;
            font-size: 32px;
            font-weight: bold;
            margin: 20px auto 30px auto;
            color: #333;
            width: 100%;
            display: block;
        }
        
        /* タブ切り替えスタイル */
        .tab-container {
            display: flex;
            margin-bottom: 30px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .tab-button {
            flex: 1;
            padding: 15px 10px;
            background: #e0e0e0;
            border: none;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0;
            height: auto;
            border-radius: 0;
        }
        
        .tab-button.active {
            background: #66BB6A;
            color: white;
        }
        
        .tab-button:hover {
            background: #d0d0d0;
        }
        
        .tab-button.active:hover {
            background: #5CAE60;
        }
        
        /* 力価計算タブがアクティブの場合 */
        .tab-button.active.potency-tab {
            background: #BA68C8;
        }
        
        .tab-button.active.potency-tab:hover {
            background: #AB47BC;
        }
        
        /* タブコンテンツ */
        .tab-content {
            display: none;
            min-height: 400px; /* タブコンテンツの最小高さを統一 */
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* 入力フィールドの位置統一 */
        .input-row-1 {
            margin-bottom: 25px;
            min-height: 120px; /* 1行目の高さを統一 */
        }
        
        .input-row-2 {
            margin-bottom: 25px;
            min-height: 80px; /* 2行目の高さを統一 */
        }
        
        /* 小児用量計算専用スタイル */
        #dose-calculator input[type="text"],
        #dose-calculator select,
        #dose-calculator .medicine-search-container {
            border: 2px solid #ddd !important;
        }
        
        #dose-calculator input[type="text"]:focus,
        #dose-calculator select:focus {
            outline: none;
            border-color: #66BB6A !important;
            box-shadow: 0 0 0 2px rgba(102, 187, 106, 0.2) !important;
        }
        
        #dose-calculator .medicine-search-container:focus-within {
            border-color: #66BB6A !important;
            box-shadow: 0 0 0 2px rgba(102, 187, 106, 0.2) !important;
        }
        
        #calculateBtn {
            background: #66BB6A !important;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            font-size: 22px;
            padding: 18px 20px;
            margin-top: 10px;
            transition: background-color 0.3s;
            -webkit-tap-highlight-color: rgba(0,0,0,0);
        }
        
        #calculateBtn:active {
            background: #5CAE60 !important;
            transform: translateY(1px);
        }
        
        #calculateBtn:hover {
            background: #5CAE60 !important;
        }
        
        #result {
            background-color: #E8F5E8 !important;
            border: 1px solid #A5D6A7 !important;
        }
        
        #result h3 {
            color: #388E3C !important;
            border-bottom: 1px solid #A5D6A7 !important;
        }
        
        /* 力価計算専用スタイル */
        #potency-calculator input[type="text"],
        #potency-calculator select {
            border: 2px solid #ddd !important;
        }
        
        /* 数値入力フィールドのIME無効化 */
        #concentration,
        #prescribedDose,
        #weight,
        #weightForAge,
        #age {
            ime-mode: disabled !important;
        }
        
        /* 薬剤検索フィールドのIMEカタカナ設定 */
        #medicineSearch {
            ime-mode: katakana !important;
        }
        
        #potency-calculator input[type="text"]:focus,
        #potency-calculator select:focus {
            outline: none;
            border-color: #BA68C8 !important;
            box-shadow: 0 0 0 2px rgba(186, 104, 200, 0.2) !important;
        }
        
        #calculatePotencyBtn {
            background: #BA68C8 !important;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            font-size: 22px;
            padding: 18px 20px;
            margin-top: 10px;
            transition: background-color 0.3s;
            -webkit-tap-highlight-color: rgba(0,0,0,0);
        }
        
        #calculatePotencyBtn:active {
            background: #AB47BC !important;
            transform: translateY(1px);
        }
        
        #calculatePotencyBtn:hover {
            background: #AB47BC !important;
        }
        
        #potencyResult {
            background-color: #FCF4FF !important;
            border: 1px solid #E1BEE7 !important;
        }
        
        #potencyResult h3 {
            color: #8E24AA !important;
            border-bottom: 1px solid #E1BEE7 !important;
        }
        
        /* スマホ用スタイル */
        @media screen and (max-width: 480px) {
            body {
                padding: 10px;
                font-size: 16px;
            }
            
            h1 {
                font-size: 28px;
                margin: 15px 0 25px 0;
            }
            
            select, input, button {
                padding: 14px 12px;
                font-size: 16px;
                margin-bottom: 12px;
            }
            
            button {
                padding: 16px;
                font-size: 18px;
            }
            
            .form-group {
                margin-bottom: 20px;
            }
            
            #result {
                padding: 12px;
            }
        }
        
        /* 入力フィールドのフォーカス時のスタイル */
        input:focus, select:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }
        
        /* 薬剤検索入力欄のコンテナ */
        .medicine-search-container {
            position: relative;
            display: flex;
            align-items: center;
            width: 100%;
            border: 2px solid #ddd !important;
            border-radius: 8px;
            background-color: #fff;
            box-sizing: border-box;
            height: 60px;
        }
        
        /* 入力欄のスタイル調整 */
        .medicine-search-container input {
            border: none !important;
            background: transparent !important;
            padding: 16px 40px 16px 20px !important;
            flex: 1;
            outline: none;
            height: 100%;
            box-sizing: border-box;
            font-size: 20px;
            margin-bottom: 0 !important;
        }
        
        
        /* クリアボタンのスタイル */
        .clear-button {
            position: absolute;
            right: 48px;
            background: none;
            color: #999;
            border: none;
            width: 30px;
            height: 30px;
            font-size: 20px;
            line-height: 1;
            cursor: pointer;
            display: none;
            padding: 0;
            font-weight: bold;
            transition: color 0.2s ease;
            -webkit-tap-highlight-color: rgba(0,0,0,0);
            border-radius: 4px;
        }
        
        .clear-button:hover {
            color: #666;
            background: rgba(0,0,0,0.05);
        }
        
        .clear-button:active {
            color: #333;
            background: rgba(0,0,0,0.1);
        }
        
        /* 入力欄にテキストがある時のクリアボタン表示 */
        .medicine-search-container.has-text .clear-button {
            display: block;
        }
        
        /* 音声入力ボタンのスタイル */
        .voice-button {
            position: absolute;
            right: 8px;
            width: 35px;
            height: 35px;
            background: #4CAF50;
            border: none;
            border-radius: 50%;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            -webkit-tap-highlight-color: rgba(0,0,0,0);
        }
        
        .voice-button:hover {
            background: #45a049;
        }
        
        .voice-button:active {
            background: #3d8b40;
            transform: scale(0.95);
        }
        
        .voice-button.recording {
            background: #f44336;
            animation: pulse 1s infinite;
        }
        
        .voice-button.recording:hover {
            background: #d32f2f;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .voice-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        /* 選択ボックスの矢印スタイル */
        select {
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23333%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 12px auto;
            padding-right: 30px;
        }
        
        
    </style>
</head>
<body>
    <h1>ようりょうくん</h1>
    
    <!-- タブ切り替えボタン -->
    <div class="tab-container">
        <button class="tab-button active dose-tab" onclick="switchTab('dose-calculator')">小児用量計算</button>
        <button class="tab-button potency-tab" onclick="switchTab('potency-calculator')">力価計算</button>
    </div>
    
    <!-- 小児用量計算タブ -->
    <div id="dose-calculator" class="tab-content active">
    
    <div class="form-group input-row-1">
        <label for="medicineSearch">💊 薬剤を検索・選択:</label>
        <div class="medicine-search-container">
            <input type="text" id="medicineSearch" placeholder="薬剤名を入力..." style="ime-mode: katakana;">
            <button type="button" class="clear-button" id="clearMedicineSearch" title="入力をクリア">×</button>
            <button type="button" class="voice-button" id="voiceSearchButton" title="音声入力">🎤</button>
        </div>
        <div id="medicineList" style="display: none; border: 1px solid #ddd; border-radius: 5px; background: white; max-height: 200px; overflow-y: auto; margin-top: 5px;"></div>
        <input type="hidden" id="selectedMedicine" name="medicine">
    </div>
    
    <div id="indicationGroup" class="form-group" style="display: none;">
        <label for="indication">適応症を選択:</label>
        <select id="indication">
            <option value="">-- 適応症を選択 --</option>
            <option value="herpesSimplex">単純疱疹</option>
            <option value="herpesZoster">帯状疱疹</option>
        </select>
    </div>
    
    <div id="weightGroup" class="form-group input-row-2">
        <label for="weight">💪 体重での計算 (kg):</label>
        <input type="text" id="weight" inputmode="decimal" pattern="[0-9]*\.?[0-9]*" placeholder="例: 15.5">
    </div>
    
    <div id="ageGroup" class="form-group" style="display: none;">
        <label for="age">🎂 年齢での計算 (歳):</label>
        <input type="text" id="age" inputmode="decimal" pattern="[0-9]*\.?[0-9]*" placeholder="例: 5 または 0.5">
    </div>
    
    <div id="weightGroupForAge" class="form-group" style="display: none;">
        <label for="weightForAge">💪 体重 (kg):</label>
        <input type="text" id="weightForAge" inputmode="decimal" pattern="[0-9]*\.?[0-9]*" placeholder="例: 15.5">
    </div>
    
    <div id="dosageOptionGroup" class="form-group" style="display: none;">
        <label for="dosageOption">用法を選択:</label>
        <select id="dosageOption">
            <option value="">-- 用法を選択 --</option>
        </select>
    </div>
    
    <button id="calculateBtn">計算する</button>
    
    <div id="result">
        <h3>計算結果</h3>
        <p><strong>薬剤名:</strong> <span id="resultMedicine">-</span></p>
        <p style="font-size: 24px; color: #2E7D32; margin: 15px 0;"><strong>1日量（秤取量）:</strong> <span id="resultDose" style="font-weight: bold; font-size: 26px;">-</span></p>
        <p><strong>1回量:</strong> <span id="resultSingleDose">-</span></p>
        <p><strong>用法:</strong> <span id="dosageInfo">-</span></p>
        <div id="contraindicationInfo" style="display: none; margin-top: 15px; padding: 10px; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px; color: #856404;">
            <strong>⚠️ 注意:</strong> <span id="contraindicationText">-</span>
        </div>
    </div>
    
    </div> <!-- 小児用量計算タブ終了 -->
    
    <!-- 力価計算タブ -->
    <div id="potency-calculator" class="tab-content">
        
        <div class="form-group input-row-1">
            <label for="concentration">🧪 薬剤の濃度 (%):</label>
            <input type="text" id="concentration" inputmode="decimal" pattern="[0-9]*\.?[0-9]*" placeholder="例: 1.0" style="ime-mode: disabled;">
        </div>
        
        <div class="form-group input-row-2">
            <label for="prescribedDose">📝 処方箋記載の用量:</label>
            <div style="display: flex; gap: 10px; align-items: stretch;">
                <input type="text" id="prescribedDose" inputmode="decimal" pattern="[0-9]*\.?[0-9]*" placeholder="例: 50" style="flex: 1; margin-bottom: 0; ime-mode: disabled;">
                <select id="doseUnit" style="flex: 0 0 80px; margin-bottom: 0;">
                    <option value="mg">mg</option>
                    <option value="μg">μg</option>
                </select>
            </div>
        </div>
        
        <button id="calculatePotencyBtn">力価計算する</button>
        
        <div id="potencyResult" style="display: none; margin-top: 25px; padding: 15px; border: 1px solid #e0e0e0; border-radius: 8px; background-color: #f9f9f9; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
            <h3>力価計算結果</h3>
            <p><strong>薬剤の濃度:</strong> <span id="resultConcentration">-</span> %</p>
            <p><strong>処方箋記載の用量:</strong> <span id="resultPrescribedDose">-</span> <span id="resultDoseUnit">-</span></p>
            <p style="font-size: 24px; color: #6A1B9A; margin: 15px 0;"><strong>1日量（秤取量）:</strong> <span id="resultWeighAmount" style="font-weight: bold; font-size: 26px;">-</span> g</p>
        </div>
        
    </div> <!-- 力価計算タブ終了 -->

    <script>
        // 薬剤データベース
        const medicines = {
            "acetaminophen": {
                name: "アセトアミノフェンDS40%「三和」",
                minDosePerKg: 30,   // mg/kg/日
                maxDosePerKg: 45,    // mg/kg/日
                frequency: 3,         // 1日3回
                concentration: 0.4    // 40%
            },
            "orapem": {
                name: "オラペネム小児用細粒10%",
                dailyDoseMultiplier: 0.08,  // 1日量 = 0.08 × 体重(kg)
                frequency: 2,                // 1日2回
                concentration: 0.1           // 10%
            },
            "ozex": {
                name: "オゼックス細粒小児用15%",
                minDosePerKg: 12,    // 1日量 12mg/kg/日
                maxDosePerKg: 12,    // 1日量 12mg/kg/日
                frequency: 2,         // 1日2回
                concentration: 0.15   // 15%
            },
            "carnal20": {
                name: "カロナール細粒20%",
                minDosePerKg: 30,    // 1日量 30-45mg/kg/日
                maxDosePerKg: 45,
                frequency: 3,         // 1日3回
                concentration: 0.2    // 20%
            },
            "carnal50": {
                name: "カロナール細粒50%",
                minDosePerKg: 30,    // 1日量 30-45mg/kg/日
                maxDosePerKg: 45,
                frequency: 3,         // 1日3回
                concentration: 0.5    // 50%
            },
            "clarith": {
                name: "クラリスDS10%小児用",
                minDosePerKg: 10,   // mg/kg/日
                maxDosePerKg: 15,    // mg/kg/日
                frequency: 2,         // 1日2回
                concentration: 0.1    // 10%
            },
            "cefzon": {
                name: "セフゾン細粒小児用10%",
                minDosePerKg: 9,     // 1日量 9-18mg/kg/日
                maxDosePerKg: 18,
                frequency: 3,         // 1日3回
                concentration: 0.1    // 10%
            },
            "farom": {
                name: "ファロムDS小児用10%",
                minDosePerKg: 15,    // 1日量 15-30mg/kg/日
                maxDosePerKg: 30,     // 1日量 15-30mg/kg/日
                frequency: 3,         // 1日3回
                concentration: 0.1    // 10%
            },
            "meiact": {
                name: "メイアクトMS小児用細粒10%",
                minDosePerKg: 9,    // mg/kg/日
                maxDosePerKg: 9,     // mg/kg/日
                frequency: 3,         // 1日3回
                concentration: 0.1    // 10%
            },
            "sawacillin": {
                name: "サワシリン細粒10%",
                minDosePerKg: 20,    // 1日量 20-40mg/kg/日
                maxDosePerKg: 40,     // 1日量 20-40mg/kg/日
                frequency: 3,         // 1日3回
                concentration: 0.1    // 10%
            },
            "flomox": {
                name: "フロモックス小児用細粒10%",
                minDosePerKg: 9,     // 1日量 9mg/kg/日
                maxDosePerKg: 9,      // 1日量 9mg/kg/日
                frequency: 3,          // 1日3回
                concentration: 0.1     // 10%
            },
            "fosmicin": {
                name: "ホスミシンDS400",
                minDosePerKg: 40,    // 1日量 40-120mg/kg/日
                maxDosePerKg: 120,   // 1日量 40-120mg/kg/日
                frequency: 3,        // 1日3～4回（3回で計算）
                concentration: 0.4   // 40%
            },
            "widesillin": {
                name: "ワイドシリン細粒20%",
                minDosePerKg: 20,    // 1日量 20-40mg/kg/日
                maxDosePerKg: 40,     // 1日量 20-40mg/kg/日
                frequency: 3,         // 1日3回
                concentration: 0.2    // 20%
            },
            "onon": {
                name: "オノンDS10%",
                minDosePerKg: 7,     // 1日量 7-10mg/kg/日
                maxDosePerKg: 10,      // 1日量 7-10mg/kg/日
                maxDailyDose: 4.5,    // 1日量の最大値 4.5g
                frequency: 2,         // 1日2回
                concentration: 0.1    // 10%
            },
            "erythro": {
                name: "エリスロシンDSW20%",
                minDosePerKg: 25,    // 1日量 25-50mg/kg/日
                maxDosePerKg: 50,     // 1日量 25-50mg/kg/日
                frequency: 4,         // 1日4回
                concentration: 0.2    // 20%
            },
            "zovirax": {
                name: "ゾビラックス顆粒40%",
                // 適応症によって異なるため、calculateDose関数内で設定
                minDosePerKg: 0,     // 計算時に設定
                maxDosePerKg: 0,      // 計算時に設定
                frequency: 3,         // 1日3回（適応症による）
                concentration: 0.4,   // 40%
                hasIndication: true   // 適応症の選択が必要
            },
            "valtrex": {
                name: "バルトレックス顆粒50%",
                // 適応症によって異なるため、calculateDose関数内で設定
                minDosePerKg: 0,     // 計算時に設定
                maxDosePerKg: 0,      // 計算時に設定
                frequency: 3,         // 1日3回
                concentration: 0.5,   // 50%
                requiresIndication: true
            },
            "tamiflu": {
                name: "タミフルDS3%(幼小児に限る)",
                dailyDosePerKg: 0.133, // 1日量 0.133g/kg
                maxDailyDose: 5,      // 1日量の最大値 5g
                frequency: 2,         // 1日2回
                concentration: 0.03   // 3%
            },
            "allelock": {
                name: "アレロック顆粒0.5%",
                type: "age-based",    // 年齢ベース薬剤
                ageRanges: [
                    { minAge: 2, maxAge: 7, dailyDoseG: 1.0 },    // 2歳以上6歳未満：1日1g
                    { minAge: 7, maxAge: 15, dailyDoseG: 2.0 }    // 7歳以上15歳未満：1日2g
                ],
                frequency: 2,         // 1日2回（朝・就寝前）
                concentration: 0.005, // 0.5%
                requiresAge: true     // 年齢入力が必要
            },
            "fexofenadine": {
                name: "フェキソフェナジン塩酸塩DS5%",
                type: "age-based",    // 年齢ベース薬剤
                ageRanges: [
                    { minAge: 0.5, maxAge: 2, dailyDoseG: 0.6 },   // 0.5歳以上2歳未満：1日0.6g
                    { minAge: 2, maxAge: 12, dailyDoseG: 1.2 },    // 2歳以上12歳未満：1日1.2g
                    { minAge: 12, maxAge: 15, dailyDoseG: 2.4 }    // 12歳以上15歳未満：1日2.4g
                ],
                frequency: 2,         // 1日2回
                concentration: 0.05,  // 5%
                requiresAge: true     // 年齢入力が必要
            },
            "claritin": {
                name: "クラリチンDS1%",
                type: "age-based",    // 年齢ベース薬剤
                ageRanges: [
                    { minAge: 3, maxAge: 7, dailyDoseG: 0.5 },     // 3歳以上7歳未満：1日0.5g
                    { minAge: 7, maxAge: 15, dailyDoseG: 1.0 }     // 7歳以上15歳未満：1日1g
                ],
                frequency: 1,         // 1日1回食後
                concentration: 0.01,  // 1%
                requiresAge: true     // 年齢入力が必要
            },
            "levocetirizine": {
                name: "レボセチリジンDS0.5%",
                type: "age-based",    // 年齢ベース薬剤
                ageRanges: [
                    { minAge: 0.5, maxAge: 1, dailyDoseG: 0.25, frequency: 1 },  // 0.5歳以上1歳未満：1日0.25g（1日1回）
                    { minAge: 1, maxAge: 7, dailyDoseG: 0.5, frequency: 2 },     // 1歳以上7歳未満：1日0.5g（1日2回）
                    { minAge: 7, maxAge: 15, dailyDoseG: 1.0, frequency: 2 }     // 7歳以上15歳未満：1日1g（1日2回）
                ],
                concentration: 0.005, // 0.5%
                requiresAge: true     // 年齢入力が必要
            },
            "zyrtec": {
                name: "ジルテックDS1.25%",
                type: "age-based",    // 年齢ベース薬剤
                ageRanges: [
                    { minAge: 2, maxAge: 7, dailyDoseG: 0.4 },     // 2歳以上7歳未満：1日0.4g
                    { minAge: 7, maxAge: 15, dailyDoseG: 0.8 }     // 7歳以上15歳未満：1日0.8g
                ],
                frequency: 2,         // 1日2回（朝食後・就寝前）
                concentration: 0.0125, // 1.25%
                requiresAge: true     // 年齢入力が必要
            },
            "asberin_powder": {
                name: "アスベリン散10%",
                type: "age-based",    // 年齢ベース薬剤
                ageRanges: [
                    { minAge: 0, maxAge: 1, minDose: 0.05, maxDose: 0.2 },    // 1歳未満：0.05～0.2g
                    { minAge: 1, maxAge: 3, minDose: 0.1, maxDose: 0.25 },    // 1歳以上3歳未満：0.1～0.25g
                    { minAge: 3, maxAge: 6, minDose: 0.15, maxDose: 0.4 }     // 3歳以上6歳未満：0.15～0.4g
                ],
                frequency: 3,         // 1日3回
                concentration: 0.1,   // 10%
                requiresAge: true     // 年齢入力が必要
            },
            "asberin_ds": {
                name: "アスベリンDS2%",
                type: "age-based",    // 年齢ベース薬剤
                ageRanges: [
                    { minAge: 0, maxAge: 1, minDose: 0.25, maxDose: 1.0 },    // 1歳未満：0.25～1g
                    { minAge: 1, maxAge: 3, minDose: 0.5, maxDose: 1.25 },    // 1歳以上3歳未満：0.5～1.25g
                    { minAge: 3, maxAge: 6, minDose: 0.75, maxDose: 2.0 }     // 3歳以上6歳未満：0.75～2g
                ],
                frequency: 3,         // 1日3回
                concentration: 0.02,  // 2%
                requiresAge: true     // 年齢入力が必要
            },
            "asberin_syrup05": {
                name: "アスベリンシロップ0.5%",
                type: "age-based",    // 年齢ベース薬剤
                ageRanges: [
                    { minAge: 0, maxAge: 1, minDose: 1, maxDose: 4, unit: "mL" },    // 1歳未満：1～4mL
                    { minAge: 1, maxAge: 3, minDose: 2, maxDose: 5, unit: "mL" },    // 1歳以上3歳未満：2～5mL
                    { minAge: 3, maxAge: 6, minDose: 3, maxDose: 8, unit: "mL" }     // 3歳以上6歳未満：3～8mL
                ],
                frequency: 3,         // 1日3回
                concentration: 0.005, // 0.5%
                requiresAge: true     // 年齢入力が必要
            },
            "asberin_syrup2": {
                name: "アスベリンシロップ「調剤用」2%",
                type: "age-based",    // 年齢ベース薬剤
                ageRanges: [
                    { minAge: 0, maxAge: 1, minDose: 0.25, maxDose: 1.0, unit: "mL" },    // 1歳未満：0.25～1mL
                    { minAge: 1, maxAge: 3, minDose: 0.5, maxDose: 1.25, unit: "mL" },    // 1歳以上3歳未満：0.5～1.25mL
                    { minAge: 3, maxAge: 6, minDose: 0.75, maxDose: 2.0, unit: "mL" }     // 3歳以上6歳未満：0.75～2mL
                ],
                frequency: 3,         // 1日3回
                concentration: 0.02,  // 2%
                requiresAge: true     // 年齢入力が必要
            },
            "mucodyne": {
                name: "ムコダインシロップ5%",
                dosePerKg: 0.6,       // 0.6mL/kg
                frequency: 3,         // 1日3回
                concentration: 0.05,  // 5%
                unit: "mL"            // 単位はmL
            },
            "mucodyne_ds": {
                name: "ムコダインDS50%",
                dosePerKgG: 0.06,     // 0.06g/kg
                frequency: 3,         // 1日3回
                concentration: 0.5,   // 50%
                unit: "g"             // 単位はg
            },
            "mucosolvan_ds": {
                name: "小児用ムコソルバンDS1.5%",
                dosePerKgG: 0.06,     // 0.06g/kg
                frequency: 3,         // 1日3回
                concentration: 0.015, // 1.5%
                unit: "g"             // 単位はg
            },
            "mucosolvan_syrup": {
                name: "小児用ムコソルバンシロップ0.3%",
                dosePerKg: 0.3,       // 0.3mL/kg
                frequency: 3,         // 1日3回
                concentration: 0.003, // 0.3%
                unit: "mL"            // 単位はmL
            },
            "zaditen_ds": {
                name: "ザジテンDS0.1%",
                dosePerKgG: 0.06,     // 0.06g/kg
                frequency: 2,         // 1日2回
                concentration: 0.001, // 0.1%
                unit: "g",            // 単位はg
                dosageNote: "朝食後・就寝前",
                contraindication: "禁忌：てんかん又はその既往歴のある患者"
            },
            "zaditen_syrup": {
                name: "ザジテンシロップ0.02%",
                dosePerKg: 0.3,       // 0.3mL/kg
                frequency: 2,         // 1日2回
                concentration: 0.0002, // 0.02%
                unit: "mL",           // 単位はmL
                dosageNote: "朝食後・就寝前",
                contraindication: "禁忌：てんかん又はその既往歴のある患者"
            },
            "xyzal_syrup": {
                name: "ザイザルシロップ0.05%",
                type: "age-based",    // 年齢ベース薬剤
                ageRanges: [
                    { minAge: 0.5, maxAge: 1, dailyDoseML: 2.5, frequency: 1 },   // 0.5歳以上1歳未満：2.5mL（1日1回）
                    { minAge: 1, maxAge: 7, dailyDoseML: 5.0, frequency: 2 },     // 1歳以上7歳未満：5mL（1日2回）
                    { minAge: 7, maxAge: 15, dailyDoseML: 10.0, frequency: 2 }    // 7歳以上15歳未満：10mL（1日2回）
                ],
                concentration: 0.0005, // 0.05%
                requiresAge: true,     // 年齢入力が必要
                unit: "mL"            // 単位はmL
            },
            "meptin_ds": {
                name: "メプチンDS0.005%",
                type: "age-based-with-options", // 年齢ベース薬剤（用法選択あり）
                ageRanges: [
                    { 
                        minAge: 0, 
                        maxAge: 6, 
                        options: [
                            { dosePerKgG: 0.05, frequency: 2, dosageNote: "朝・就寝前" },
                            { dosePerKgG: 0.075, frequency: 3, dosageNote: "朝・昼・就寝前" }
                        ]
                    },
                    { 
                        minAge: 6, 
                        maxAge: 15, 
                        options: [
                            { dailyDoseG: 0.5, frequency: 1, dosageNote: "就寝前" },
                            { dailyDoseG: 1.0, frequency: 2, dosageNote: "朝・就寝前" }
                        ]
                    }
                ],
                requiresAge: true,     // 年齢入力が必要
                requiresOption: true,  // 用法選択が必要
                unit: "g"             // 単位はg
            },
            "meptin_syrup": {
                name: "メプチンシロップ5μg/mL",
                type: "age-based-with-options", // 年齢ベース薬剤（用法選択あり）
                ageRanges: [
                    { 
                        minAge: 0, 
                        maxAge: 6, 
                        options: [
                            { dosePerKg: 0.5, frequency: 2, dosageNote: "朝・就寝前" },
                            { dosePerKg: 0.75, frequency: 3, dosageNote: "朝・昼・就寝前" }
                        ]
                    },
                    { 
                        minAge: 6, 
                        maxAge: 15, 
                        options: [
                            { dailyDoseML: 5, frequency: 1, dosageNote: "就寝前" },
                            { dailyDoseML: 10, frequency: 2, dosageNote: "朝・就寝前" }
                        ]
                    }
                ],
                requiresAge: true,     // 年齢入力が必要
                requiresOption: true,  // 用法選択が必要
                unit: "mL"            // 単位はmL
            },
            "kefral": {
                name: "ケフラール細粒小児用100mg",
                minDosePerKg: 20,    // mg/kg/日 (0.02g/kg = 20mg/kg)
                maxDosePerKg: 40,    // mg/kg/日 (0.04g/kg = 40mg/kg)
                frequency: 3,        // 1日3回
                concentration: 0.1   // 100mg/g = 10%
            },
            "zithromax": {
                name: "ジスロマック細粒小児用10%",
                minDosePerKg: 10,    // mg/kg/日 (0.01g/kg = 10mg/kg)
                maxDosePerKg: 10,    // mg/kg/日 (0.01g/kg = 10mg/kg)
                frequency: 1,        // 1日1回
                concentration: 0.1,  // 10%
                dosageNote: "3日間服用"
            }
        };


        // タブ切り替え機能
        function switchTab(tabName) {
            // すべてのタブコンテンツを非表示
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));
            
            // すべてのタブボタンを非アクティブ
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => button.classList.remove('active'));
            
            // 選択されたタブを表示
            document.getElementById(tabName).classList.add('active');
            
            // 対応するタブボタンをアクティブに
            const activeButton = document.querySelector(`[onclick="switchTab('${tabName}')"]`);
            if (activeButton) {
                activeButton.classList.add('active');
            }
            
            // 結果を非表示にする
            document.getElementById('result').style.display = 'none';
            document.getElementById('potencyResult').style.display = 'none';
        }

        // 力価計算機能
        function calculatePotency() {
            const concentration = parseFloat(document.getElementById('concentration').value);
            const prescribedDose = parseFloat(document.getElementById('prescribedDose').value);
            const doseUnit = document.getElementById('doseUnit').value;
            const resultDiv = document.getElementById('potencyResult');
            
            // 入力チェック
            if (isNaN(concentration) || concentration <= 0) {
                alert('正しい濃度を入力してください（0より大きい数値）');
                return;
            }
            
            if (isNaN(prescribedDose) || prescribedDose <= 0) {
                alert('正しい用量を入力してください（0より大きい数値）');
                return;
            }
            
            // 力価計算（単位に応じた計算）
            let weighAmount;
            let divisor;
            
            if (doseUnit === 'mg') {
                // mg の場合: 秤取量（1日量）= 100 ÷ 薬剤の濃度(%) × 処方箋に記載の用量(mg) ÷ 1000
                weighAmount = (100 / concentration) * prescribedDose / 1000;
                divisor = '1000';
            } else if (doseUnit === 'μg') {
                // μg の場合: 秤取量（1日量）= 100 ÷ 薬剤の濃度(%) × 処方箋に記載の用量(μg) ÷ 1000000
                weighAmount = (100 / concentration) * prescribedDose / 1000000;
                divisor = '1000000';
            }
            
            // 結果を表示
            document.getElementById('resultConcentration').textContent = concentration.toFixed(2);
            document.getElementById('resultPrescribedDose').textContent = prescribedDose.toFixed(1);
            document.getElementById('resultDoseUnit').textContent = doseUnit;
            document.getElementById('resultWeighAmount').textContent = weighAmount.toFixed(2);
            
            // 結果を表示
            resultDiv.style.display = 'block';
        }

        // 力価計算でのEnterキーによる次フィールドへの移動
        document.getElementById('concentration').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('prescribedDose').focus();
            }
        });
        
        document.getElementById('prescribedDose').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                calculatePotency();
            }
        });

        // イベントリスナー
        document.getElementById('calculateBtn').addEventListener('click', calculateDose);
        document.getElementById('calculatePotencyBtn').addEventListener('click', calculatePotency);

        // エンターキーでも計算できるように（フォーム全体で動作するように修正）
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                // 力価計算の個別フィールドの場合は処理をスキップ
                const target = e.target;
                if (target.id === 'concentration' || target.id === 'prescribedDose') {
                    return; // 個別のイベントリスナーに任せる
                }
                
                e.preventDefault();
                
                // 現在アクティブなタブに応じて計算を実行
                const activeDoseTab = document.getElementById('dose-calculator').classList.contains('active');
                const activePotencyTab = document.getElementById('potency-calculator').classList.contains('active');
                
                if (activeDoseTab) {
                    calculateDose();
                } else if (activePotencyTab) {
                    calculatePotency();
                }
            }
        });


        // 薬剤検索機能
        const allMedicines = [
            {value: "asberin_powder", text: "アスベリン散10%"},
            {value: "asberin_ds", text: "アスベリンDS2%"},
            {value: "asberin_syrup05", text: "アスベリンシロップ0.5%"},
            {value: "asberin_syrup2", text: "アスベリンシロップ「調剤用」2%"},
            {value: "acetaminophen", text: "アセトアミノフェンDS40%「三和」"},
            {value: "allelock", text: "アレロック顆粒0.5%"},
            {value: "erythro", text: "エリスロシンDSW20%"},
            {value: "ozex", text: "オゼックス細粒小児用15%"},
            {value: "onon", text: "オノンDS10%"},
            {value: "orapem", text: "オラペネム小児用細粒10%"},
            {value: "carnal20", text: "カロナール細粒20%"},
            {value: "carnal50", text: "カロナール細粒50%"},
            {value: "kefral", text: "ケフラール細粒小児用100mg"},
            {value: "clarith", text: "クラリスDS10%小児用"},
            {value: "claritin", text: "クラリチンDS1%"},
            {value: "mucodyne", text: "ムコダインシロップ5%"},
            {value: "mucodyne_ds", text: "ムコダインDS50%"},
            {value: "mucosolvan_ds", text: "小児用ムコソルバンDS1.5%"},
            {value: "mucosolvan_syrup", text: "小児用ムコソルバンシロップ0.3%"},
            {value: "sawacillin", text: "サワシリン細粒10%"},
            {value: "zaditen_ds", text: "ザジテンDS0.1%"},
            {value: "zaditen_syrup", text: "ザジテンシロップ0.02%"},
            {value: "xyzal_syrup", text: "ザイザルシロップ0.05%"},
            {value: "zyrtec", text: "ジルテックDS1.25%"},
            {value: "cefzon", text: "セフゾン細粒小児用10%"},
            {value: "zithromax", text: "ジスロマック細粒小児用10%"},
            {value: "zovirax", text: "ゾビラックス顆粒40%"},
            {value: "tamiflu", text: "タミフルDS3%(幼小児に限る)"},
            {value: "valtrex", text: "バルトレックス顆粒50%"},
            {value: "farom", text: "ファロムDS小児用10%"},
            {value: "fexofenadine", text: "フェキソフェナジン塩酸塩DS5%"},
            {value: "flomox", text: "フロモックス小児用細粒10%"},
            {value: "fosmicin", text: "ホスミシンDS400"},
            {value: "meiact", text: "メイアクトMS小児用細粒10%"},
            {value: "meptin_ds", text: "メプチンDS0.005%"},
            {value: "meptin_syrup", text: "メプチンシロップ5μg/mL"},
            {value: "levocetirizine", text: "レボセチリジンDS0.5%"},
            {value: "widesillin", text: "ワイドシリン細粒20%"}
        ];

        // ひらがなをカタカナに変換する関数
        function hiraganaToKatakana(str) {
            return str.replace(/[\u3041-\u3096]/g, function(match) {
                var chr = match.charCodeAt(0) + 0x60;
                return String.fromCharCode(chr);
            });
        }
        
        // カタカナをひらがなに変換する関数
        function katakanaToHiragana(str) {
            return str.replace(/[\u30a1-\u30f6]/g, function(match) {
                var chr = match.charCodeAt(0) - 0x60;
                return String.fromCharCode(chr);
            });
        }

        let selectedIndex = -1;
        let currentOptions = [];

        // クリアボタンの表示制御
        function updateClearButtonVisibility() {
            const searchInput = document.getElementById('medicineSearch');
            const container = searchInput.parentElement;
            if (searchInput.value.trim() !== '') {
                container.classList.add('has-text');
            } else {
                container.classList.remove('has-text');
            }
        }
        
        // 音声認識の変数
        let recognition = null;
        let isRecording = false;
        
        // 音声認識の初期化
        function initSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                
                recognition.lang = 'ja-JP';
                recognition.continuous = false;
                recognition.interimResults = isMobile() ? true : false;  // スマホでは中間結果表示
                recognition.maxAlternatives = 1;
                
                recognition.onstart = function() {
                    isRecording = true;
                    const voiceButton = document.getElementById('voiceSearchButton');
                    voiceButton.classList.add('recording');
                    voiceButton.title = '録音中...';
                };
                
                recognition.onresult = function(event) {
                    const searchInput = document.getElementById('medicineSearch');
                    
                    // 結果の存在チェック
                    if (!event.results || !event.results[0] || !event.results[0][0]) {
                        console.warn('音声認識結果が空です');
                        return;
                    }
                    
                    // スマホでは中間結果も表示
                    if (isMobile() && event.results[0].isFinal === false) {
                        const transcript = event.results[0][0].transcript;
                        if (transcript.trim()) {  // 空文字チェック
                            searchInput.value = transcript + '...';
                            searchInput.style.color = '#999';  // 中間結果は薄く表示
                        }
                        return;
                    }
                    
                    // 最終結果
                    const result = event.results[0][0].transcript;
                    if (result.trim()) {  // 空文字チェック
                        searchInput.value = result;
                        searchInput.style.color = '';  // 通常色に戻す
                        
                        // 検索を実行
                        handleMedicineInput();
                    } else {
                        console.warn('音声認識結果が空文字です');
                        searchInput.style.color = '';  // 色をリセット
                    }
                };
                
                recognition.onerror = function(event) {
                    console.error('音声認識エラー:', event.error);
                    stopRecording();
                    
                    if (event.error === 'not-allowed') {
                        alert('マイクのアクセス許可が必要です。ブラウザの設定でマイクを有効にしてください。');
                    } else if (event.error === 'no-speech') {
                        alert('音声が検出されませんでした。もう一度お試しください。');
                    } else {
                        alert('音声認識でエラーが発生しました: ' + event.error);
                    }
                };
                
                recognition.onend = function() {
                    stopRecording();
                };
                
                return true;
            }
            return false;
        }
        
        function stopRecording() {
            isRecording = false;
            const voiceButton = document.getElementById('voiceSearchButton');
            const searchInput = document.getElementById('medicineSearch');
            
            voiceButton.classList.remove('recording');
            voiceButton.title = '音声入力';
            
            // 中間結果表示中の場合、色をリセット
            if (searchInput.style.color === 'rgb(153, 153, 153)' || searchInput.style.color === '#999') {
                searchInput.style.color = '';
            }
        }
        
        // 音声入力ボタンのクリックイベント
        document.getElementById('voiceSearchButton').addEventListener('click', function() {
            if (!recognition) {
                const isSupported = initSpeechRecognition();
                if (!isSupported) {
                    alert('お使いのブラウザは音声認識に対応していません。Chrome、Edge、Safariをお使いください。');
                    return;
                }
            }
            
            if (isRecording) {
                recognition.stop();
            } else {
                try {
                    recognition.start();
                } catch (error) {
                    console.error('音声認識開始エラー:', error);
                    alert('音声認識を開始できませんでした。');
                }
            }
        });
        
        // クリアボタンのクリックイベント
        document.getElementById('clearMedicineSearch').addEventListener('click', function() {
            const searchInput = document.getElementById('medicineSearch');
            const medicineList = document.getElementById('medicineList');
            const selectedMedicine = document.getElementById('selectedMedicine');
            
            // 入力内容をクリア
            searchInput.value = '';
            selectedMedicine.value = '';
            
            // 候補リストを非表示
            medicineList.style.display = 'none';
            currentOptions = [];
            selectedIndex = -1;
            
            // クリアボタンを非表示
            updateClearButtonVisibility();
            
            // 入力欄にフォーカス
            searchInput.focus();
            
            // 薬剤選択の状態をリセット
            triggerMedicineChange('');
        });
        
        let isComposing = false; // IME入力中フラグ
        
        // モバイルデバイス検出
        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                   ('ontouchstart' in window) || 
                   (navigator.maxTouchPoints > 0);
        }
        
        // IME入力開始・終了の検知
        document.getElementById('medicineSearch').addEventListener('compositionstart', function() {
            isComposing = true;
        });
        
        document.getElementById('medicineSearch').addEventListener('compositionend', function() {
            isComposing = false;
            // IME確定後に検索処理を実行
            setTimeout(() => {
                handleMedicineInput();
            }, 50);
        });
        
        document.getElementById('medicineSearch').addEventListener('input', function() {
            // 薬剤選択中の場合は処理をスキップ
            if (isSelectingMedicine) {
                return;
            }
            
            // IME入力中の場合は処理をスキップ
            if (isComposing) {
                return;
            }
            
            // 音声入力中の場合は処理をスキップ
            if (isRecording) {
                return;
            }
            
            handleMedicineInput();
        });
        
        function handleMedicineInput() {
            const searchInput = document.getElementById('medicineSearch');
            let originalValue = searchInput.value;
            
            // 検索語として使用する値（変換は検索時のみ行い、入力フィールドは変更しない）
            let searchTerm = originalValue;
            const medicineList = document.getElementById('medicineList');
            selectedIndex = -1; // リセット
            
            // クリアボタンの表示制御
            updateClearButtonVisibility();
            
            if (searchTerm === '') {
                medicineList.style.display = 'none';
                currentOptions = [];
                return;
            }
            
            // 検索条件に合う薬剤を絞り込み
            const filteredMedicines = allMedicines.filter(medicine => {
                const medicineText = medicine.text.toLowerCase();
                const searchTermLower = searchTerm.toLowerCase();
                
                // 入力された文字列をそのまま検索
                if (medicineText.includes(searchTermLower)) {
                    return true;
                }
                
                // ひらがなで入力された場合、カタカナに変換して検索
                const katakanaSearchTerm = hiraganaToKatakana(searchTermLower);
                if (medicineText.includes(katakanaSearchTerm.toLowerCase())) {
                    return true;
                }
                
                // カタカナで入力された場合、ひらがなに変換して検索
                const hiraganaSearchTerm = katakanaToHiragana(searchTermLower);
                if (medicineText.includes(hiraganaSearchTerm.toLowerCase())) {
                    return true;
                }
                
                return false;
            });
            
            currentOptions = filteredMedicines;
            
            if (filteredMedicines.length === 0) {
                medicineList.innerHTML = '<div style="padding: 10px; color: #666;">該当する薬剤がありません</div>';
                medicineList.style.display = 'block';
                currentOptions = [];
                return;
            }
            
            // 候補リストを表示
            medicineList.innerHTML = filteredMedicines.map((medicine, index) => 
                `<div class="medicine-option" data-value="${medicine.value}" data-index="${index}" style="padding: 10px; cursor: pointer; border-bottom: 1px solid #eee;">${medicine.text}</div>`
            ).join('');
            
            medicineList.style.display = 'block';
            
            // 候補選択時の処理（スマホ対応）
            medicineList.querySelectorAll('.medicine-option').forEach(option => {
                // タッチイベント対応（スマホ用）
                option.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    selectMedicine(this);
                });
                
                // クリックイベント（デスクトップ用）
                option.addEventListener('click', function() {
                    selectMedicine(this);
                });
                
                option.addEventListener('mouseover', function() {
                    clearSelection();
                    this.style.backgroundColor = '#f0f0f0';
                });
                
                option.addEventListener('mouseout', function() {
                    if (!this.classList.contains('selected')) {
                        this.style.backgroundColor = '';
                    }
                });
            });
        }

        // キーボード操作の処理
        document.getElementById('medicineSearch').addEventListener('keydown', function(e) {
            const medicineList = document.getElementById('medicineList');
            const options = medicineList.querySelectorAll('.medicine-option');
            
            if (options.length === 0) return;
            
            switch(e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    selectedIndex = (selectedIndex + 1) % options.length;
                    updateSelection(options);
                    break;
                    
                case 'ArrowUp':
                    e.preventDefault();
                    selectedIndex = selectedIndex <= 0 ? options.length - 1 : selectedIndex - 1;
                    updateSelection(options);
                    break;
                    
                case 'Enter':
                    e.preventDefault();
                    if (selectedIndex >= 0 && options[selectedIndex]) {
                        selectMedicine(options[selectedIndex]);
                    } else {
                        // 薬剤が既に選択されている場合は次の入力欄へ
                        const selectedMedicine = document.getElementById('selectedMedicine').value;
                        if (selectedMedicine) {
                            // 薬剤が選択済みの場合
                            focusNextInput();
                        } else {
                            // 薬剤が選択されていない場合でもスマホでは体重入力に移動
                            if (isMobile() && this.value.trim() !== '') {
                                setTimeout(() => {
                                    document.getElementById('weight').focus();
                                    document.getElementById('weight').click();
                                }, 100);
                            }
                        }
                    }
                    break;
                    
                case 'Escape':
                    medicineList.style.display = 'none';
                    selectedIndex = -1;
                    break;
            }
        });

        function updateSelection(options) {
            clearSelection();
            if (selectedIndex >= 0 && options[selectedIndex]) {
                options[selectedIndex].style.backgroundColor = '#e3f2fd';
                options[selectedIndex].classList.add('selected');
            }
        }

        function clearSelection() {
            const options = document.querySelectorAll('.medicine-option');
            options.forEach(option => {
                option.style.backgroundColor = '';
                option.classList.remove('selected');
            });
        }

        let isSelectingMedicine = false; // 薬剤選択中フラグ
        
        // 次の入力欄にフォーカスを移動する関数（デスクトップ用）
        function focusNextInput() {
            const medicineId = document.getElementById('selectedMedicine').value;
            const medicine = medicines[medicineId];
            
            if (!medicine) return;
            
            // スマホの場合は薬剤タイプに関係なく、表示されている次の入力欄に移動
            if (isMobile()) {
                setTimeout(() => {
                    // 年齢ベース薬剤の場合は年齢入力に移動
                    if (medicine.type === 'age-based-with-options' || medicine.requiresAge) {
                        const ageInput = document.getElementById('age');
                        if (ageInput && ageInput.offsetParent !== null) {
                            ageInput.focus();
                            ageInput.click();
                            return;
                        }
                    }
                    // 適応症選択が必要な薬剤の場合
                    if (medicine.hasIndication) {
                        const indicationInput = document.getElementById('indication');
                        if (indicationInput && indicationInput.offsetParent !== null) {
                            indicationInput.focus();
                            indicationInput.click();
                            return;
                        }
                    }
                    // 通常の体重ベース薬剤の場合、または他の入力欄が表示されていない場合
                    const weightInput = document.getElementById('weight');
                    if (weightInput && weightInput.offsetParent !== null) {
                        weightInput.focus();
                        weightInput.click();
                    }
                }, 100);
                return;
            }
            
            // デスクトップの場合は薬剤タイプ別に移動
            // 年齢ベース薬剤（用法選択あり）の場合
            if (medicine.type === 'age-based-with-options') {
                document.getElementById('age').focus();
            } 
            // 年齢ベース薬剤の場合
            else if (medicine.requiresAge) {
                document.getElementById('age').focus();
            } 
            // 適応症選択が必要な薬剤の場合
            else if (medicine.hasIndication) {
                document.getElementById('indication').focus();
            } 
            // 通常の体重ベース薬剤の場合
            else {
                document.getElementById('weight').focus();
            }
        }
        
        function selectMedicine(optionElement) {
            const value = optionElement.getAttribute('data-value');
            const text = optionElement.textContent.trim();
            
            // 薬剤選択中フラグを設定
            isSelectingMedicine = true;
            
            // 入力フィールドを直接候補の薬剤名に設定
            const searchInput = document.getElementById('medicineSearch');
            searchInput.value = text;
            document.getElementById('selectedMedicine').value = value;
            document.getElementById('medicineList').style.display = 'none';
            selectedIndex = -1;
            currentOptions = [];
            
            // クリアボタンの表示制御
            updateClearButtonVisibility();
            
            // 薬剤選択イベントを発火
            triggerMedicineChange(value);
            
            // フラグをリセット
            setTimeout(() => {
                isSelectingMedicine = false;
                // スマホの場合はタッチ選択後に体重入力欄にフォーカス
                if (isMobile()) {
                    setTimeout(() => {
                        const weightInput = document.getElementById('weight');
                        weightInput.focus();
                        // スマホでキーボードを確実に表示
                        weightInput.click();
                    }, 300);
                }
            }, 100);
        }
        
        // 薬剤選択時の処理を関数化
        function triggerMedicineChange(medicineId) {
            const indicationGroup = document.getElementById('indicationGroup');
            const weightGroup = document.getElementById('weightGroup');
            const ageGroup = document.getElementById('ageGroup');
            const weightGroupForAge = document.getElementById('weightGroupForAge');
            const dosageOptionGroup = document.getElementById('dosageOptionGroup');
            const indicationSelect = document.getElementById('indication');
            const dosageOptionSelect = document.getElementById('dosageOption');
            
            // 入力欄をリセット
            document.getElementById('weight').value = '';
            document.getElementById('weightForAge').value = '';
            document.getElementById('age').value = '';
            indicationSelect.value = '';
            dosageOptionSelect.value = '';
            
            // 結果を非表示
            document.getElementById('result').style.display = 'none';
            
            // 年齢ベース薬剤（用法選択あり）の場合
            if (medicineId && medicines[medicineId]?.type === 'age-based-with-options') {
                indicationGroup.style.display = 'none';
                weightGroup.style.display = 'none';
                ageGroup.style.display = 'block';
                weightGroupForAge.style.display = 'none'; // 年齢入力後に表示
                dosageOptionGroup.style.display = 'none'; // 年齢入力後に表示
            } else if (medicineId && medicines[medicineId]?.requiresAge) {
                // 年齢ベース薬剤の場合
                indicationGroup.style.display = 'none';
                weightGroup.style.display = 'none';
                ageGroup.style.display = 'block';
                weightGroupForAge.style.display = 'none';
                dosageOptionGroup.style.display = 'none';
            } else if (medicineId && medicines[medicineId]?.hasIndication) {
                // 適応症選択が必要な薬剤の場合
                indicationGroup.style.display = 'block';
                weightGroup.style.display = 'none';
                ageGroup.style.display = 'none';
                weightGroupForAge.style.display = 'none';
                dosageOptionGroup.style.display = 'none';
            } else {
                // 通常の体重ベース薬剤の場合
                indicationGroup.style.display = 'none';
                weightGroup.style.display = 'block';
                ageGroup.style.display = 'none';
                weightGroupForAge.style.display = 'none';
                dosageOptionGroup.style.display = 'none';
            }
        }

        
        // 適応症選択時のイベントリスナー
        document.getElementById('indication').addEventListener('change', function() {
            // 適応症が選択されたら体重入力欄を表示
            if (this.value) {
                document.getElementById('weightGroup').style.display = 'block';
            } else {
                document.getElementById('weightGroup').style.display = 'none';
            }
        });

        // 年齢入力時のイベントリスナー（メプチン用）
        document.getElementById('age').addEventListener('input', function() {
            const medicineId = document.getElementById('selectedMedicine').value;
            const medicine = medicines[medicineId];
            const dosageOptionGroup = document.getElementById('dosageOptionGroup');
            const dosageOptionSelect = document.getElementById('dosageOption');
            
            if (medicine?.type === 'age-based-with-options' && this.value) {
                const age = parseFloat(this.value);
                if (!isNaN(age) && age >= 0) {
                    // 年齢に該当する選択肢を検索
                    let matchedRange = null;
                    for (const range of medicine.ageRanges) {
                        if (age >= range.minAge && age < range.maxAge) {
                            matchedRange = range;
                            break;
                        }
                    }
                    
                    if (matchedRange) {
                        // 用法選択肢を生成
                        dosageOptionSelect.innerHTML = '<option value="">-- 用法を選択 --</option>';
                        matchedRange.options.forEach((option, index) => {
                            const optionText = `1日${option.frequency}回（${option.dosageNote}）`;
                            dosageOptionSelect.innerHTML += `<option value="${index}">${optionText}</option>`;
                        });
                        dosageOptionGroup.style.display = 'block';
                        
                        // 0-6歳未満の場合は体重入力も必要
                        if (age < 6) {
                            document.getElementById('weightGroupForAge').style.display = 'block';
                        } else {
                            document.getElementById('weightGroupForAge').style.display = 'none';
                        }
                    } else {
                        dosageOptionGroup.style.display = 'none';
                        document.getElementById('weightGroupForAge').style.display = 'none';
                    }
                } else {
                    dosageOptionGroup.style.display = 'none';
                    document.getElementById('weightGroupForAge').style.display = 'none';
                }
            } else {
                dosageOptionGroup.style.display = 'none';
                document.getElementById('weightGroupForAge').style.display = 'none';
            }
        });

        // 禁忌情報を表示する関数
        function showContraindicationInfo(medicine) {
            const contraindicationDiv = document.getElementById('contraindicationInfo');
            const contraindicationText = document.getElementById('contraindicationText');
            
            if (medicine.contraindication) {
                contraindicationText.textContent = medicine.contraindication;
                contraindicationDiv.style.display = 'block';
            } else {
                contraindicationDiv.style.display = 'none';
            }
        }

        // 投与量を計算する関数
        function calculateDose() {
            const medicineId = document.getElementById('selectedMedicine').value;
            const resultDiv = document.getElementById('result');
            const medicine = JSON.parse(JSON.stringify(medicines[medicineId])); // オブジェクトをディープコピー
            
            // 入力チェック
            if (!medicineId) {
                alert('薬剤を選択してください');
                return;
            }
            
            // 年齢ベース薬剤（用法選択あり）の場合
            if (medicine?.type === 'age-based-with-options') {
                const ageInput = document.getElementById('age').value;
                const age = parseFloat(ageInput);
                const dosageOptionIndex = document.getElementById('dosageOption').value;
                
                if (isNaN(age) || age <= 0) {
                    alert('正しい年齢を入力してください（0より大きい数値）');
                    return;
                }
                
                if (dosageOptionIndex === '') {
                    alert('用法を選択してください');
                    return;
                }
                
                // 年齢に該当する用量を検索
                let matchedRange = null;
                for (const range of medicine.ageRanges) {
                    if (age >= range.minAge && age < range.maxAge) {
                        matchedRange = range;
                        break;
                    }
                }
                
                if (!matchedRange) {
                    alert(`${age}歳は対象年齢外です`);
                    return;
                }
                
                const selectedOption = matchedRange.options[parseInt(dosageOptionIndex)];
                if (!selectedOption) {
                    alert('選択した用法が無効です');
                    return;
                }
                
                let dailyDose, singleDose, unit;
                
                // 体重ベースの計算（0-6歳未満）
                if (selectedOption.dosePerKgG || selectedOption.dosePerKg) {
                    const weightInput = document.getElementById('weightForAge').value;
                    const weight = parseFloat(weightInput);
                    
                    if (isNaN(weight) || weight <= 0) {
                        alert('正しい体重を入力してください（0より大きい数値）');
                        document.getElementById('weightGroupForAge').style.display = 'block';
                        return;
                    }
                    
                    if (selectedOption.dosePerKgG) {
                        // g単位の計算
                        dailyDose = selectedOption.dosePerKgG * weight;
                        unit = 'g';
                    } else {
                        // mL単位の計算
                        dailyDose = selectedOption.dosePerKg * weight;
                        unit = 'mL';
                    }
                } else {
                    // 固定用量（6歳以上）
                    if (selectedOption.dailyDoseG) {
                        dailyDose = selectedOption.dailyDoseG;
                        unit = 'g';
                    } else {
                        dailyDose = selectedOption.dailyDoseML;
                        unit = 'mL';
                    }
                }
                
                singleDose = dailyDose / selectedOption.frequency;
                
                // 結果を表示
                document.getElementById('resultDose').innerHTML = `${dailyDose.toFixed(2)} ${unit}`;
                document.getElementById('resultSingleDose').innerHTML = `${singleDose.toFixed(2)} ${unit}`;
                document.getElementById('resultMedicine').textContent = medicine.name;
                document.getElementById('dosageInfo').textContent = `1日${selectedOption.frequency}回（${selectedOption.dosageNote}）`;
                
                // 禁忌情報を表示
                showContraindicationInfo(medicine);
                
                // 結果を表示
                resultDiv.style.display = 'block';
                return;
            } else if (medicine?.requiresAge) {
                const ageInput = document.getElementById('age').value;
                const age = parseFloat(ageInput);
                
                if (isNaN(age) || age <= 0) {
                    alert('正しい年齢を入力してください（0より大きい数値）');
                    return;
                }
                
                // 年齢に該当する用量を検索
                let matchedRange = null;
                for (const range of medicine.ageRanges) {
                    if (age >= range.minAge && age < range.maxAge) {
                        matchedRange = range;
                        break;
                    }
                }
                
                if (!matchedRange) {
                    alert(`${age}歳は対象年齢外です`);
                    return;
                }
                
                // 年齢ベースの計算
                let dailyDoseG, singleDoseG, frequency;
                
                // ザイザルシロップ（mL固定用量）の場合
                if (matchedRange.dailyDoseML) {
                    const dailyDoseML = matchedRange.dailyDoseML;
                    frequency = matchedRange.frequency;
                    const singleDoseML = dailyDoseML / frequency;
                    
                    // 結果を表示（mL単位）
                    document.getElementById('resultDose').innerHTML = `${dailyDoseML.toFixed(1)} mL`;
                    document.getElementById('resultSingleDose').innerHTML = `${singleDoseML.toFixed(1)} mL`;
                    document.getElementById('resultMedicine').textContent = medicine.name;
                    
                    // ザイザルシロップの用法表示
                    if (frequency === 1) {
                        document.getElementById('dosageInfo').textContent = `1日${frequency}回`;
                    } else {
                        document.getElementById('dosageInfo').textContent = `1日${frequency}回（朝食後・就寝前）`;
                    }
                    
                    // 禁忌情報を表示
                    showContraindicationInfo(medicine);
                    
                    // 結果を表示
                    resultDiv.style.display = 'block';
                    return;
                } else if (matchedRange.minDose && matchedRange.maxDose) {
                    // アスベリン系薬剤（範囲指定）の場合
                    frequency = medicine.frequency;
                    const minDose = matchedRange.minDose;
                    const maxDose = matchedRange.maxDose;
                    const unit = matchedRange.unit || "g";
                    
                    // 結果を表示
                    document.getElementById('resultDose').innerHTML = `${minDose} - ${maxDose} ${unit}`;
                    document.getElementById('resultSingleDose').innerHTML = `${(minDose/frequency).toFixed(2)} - ${(maxDose/frequency).toFixed(2)} ${unit}`;
                    document.getElementById('resultMedicine').textContent = medicine.name;
                    document.getElementById('dosageInfo').textContent = `1日${frequency}回`;
                    
                    // 禁忌情報を表示
                    showContraindicationInfo(medicine);
                    
                    // 結果を表示
                    resultDiv.style.display = 'block';
                    return;
                } else {
                    // 従来の固定用量薬剤
                    dailyDoseG = matchedRange.dailyDoseG;
                    // レボセチリジンは年齢範囲ごとに投与回数が異なる
                    frequency = matchedRange.frequency || medicine.frequency;
                    singleDoseG = dailyDoseG / frequency;
                }
                
                // 結果を表示
                document.getElementById('resultDose').innerHTML = `${dailyDoseG.toFixed(2)} g`;
                document.getElementById('resultSingleDose').innerHTML = `${singleDoseG.toFixed(2)} g`;
                document.getElementById('resultMedicine').textContent = medicine.name;
                // 薬剤ごとに用法を設定
                if (medicineId === 'allelock') {
                    document.getElementById('dosageInfo').textContent = `1日${frequency}回（朝・就寝前）`;
                } else if (medicineId === 'claritin') {
                    document.getElementById('dosageInfo').textContent = `1日${frequency}回（食後）`;
                } else if (medicineId === 'levocetirizine') {
                    if (frequency === 1) {
                        document.getElementById('dosageInfo').textContent = `1日${frequency}回`;
                    } else {
                        document.getElementById('dosageInfo').textContent = `1日${frequency}回（朝食後・就寝前）`;
                    }
                } else if (medicineId === 'zyrtec') {
                    document.getElementById('dosageInfo').textContent = `1日${frequency}回（朝食後・就寝前）`;
                } else {
                    document.getElementById('dosageInfo').textContent = `1日${frequency}回`;
                }
                
                // 禁忌情報を表示
                showContraindicationInfo(medicine);
                
                // 結果を表示
                resultDiv.style.display = 'block';
                return;
            }
            
            // 体重ベース薬剤の場合（既存処理）
            const weightInput = document.getElementById('weight').value;
            const weight = parseFloat(weightInput);
            
            if (isNaN(weight) || weight <= 0) {
                alert('正しい体重を入力してください（0より大きい数値）');
                return;
            }
            
            let dailyDoseMg, singleDoseMg, dailyDoseG, singleDoseG;
            
            // 適応症に応じて投与量を設定
            if (medicineId === 'zovirax' || medicineId === 'valtrex') {
                const indication = document.getElementById('indication').value;
                if (medicineId === 'zovirax') {
                    if (indication === 'herpesSimplex') {
                        // 単純疱疹の場合（ゾビラックス）
                        // 10kg未満: 80mg/kg/日、10kg以上: 2.0g/日
                        medicine.minDosePerKg = 80;  // 80mg/kg/日
                        medicine.maxDosePerKg = 80;  // 80mg/kg/日
                        medicine.frequency = 4;      // 1日4回
                        medicine.maxDailyDoseG = 2.0; // 1日最大2g
                        medicine.maxWeightForDose = 10; // 10kg以上は2.0g/日で固定
                    } else if (indication === 'herpesZoster') {
                        // 帯状疱疹の場合（ゾビラックス）
                        medicine.minDosePerKg = 80;  // 80mg/kg/日
                        medicine.maxDosePerKg = 80;  // 80mg/kg/日
                        medicine.frequency = 5;      // 1日5回
                    }
                } else if (medicineId === 'valtrex') {
                    if (indication === 'herpesSimplex') {
                        // 単純疱疹の場合（バルトレックス）
                        // 20kg未満: 50mg/kg/日、20kg以上: 2.0g/日
                        medicine.minDosePerKg = 50;  // 50mg/kg/日
                        medicine.maxDosePerKg = 50;  // 50mg/kg/日
                        medicine.frequency = 2;      // 1日2回
                        medicine.maxDailyDoseG = 2.0; // 1日最大2g
                        medicine.maxWeightForDose = 20; // 20kg以上は2.0g/日で固定
                    } else if (indication === 'herpesZoster') {
                        // 帯状疱疹の場合（バルトレックス）
                        // 40kg未満: 75mg/kg/日、40kg以上: 6.0g/日
                        medicine.minDosePerKg = 75;  // 75mg/kg/日
                        medicine.maxDosePerKg = 75;  // 75mg/kg/日
                        medicine.frequency = 3;      // 1日3回
                        medicine.maxDailyDoseG = 6.0; // 1日最大6g
                        medicine.maxWeightForDose = 40; // 40kg以上は6.0g/日で固定
                        
                        // 40kg以上の場合は常に6.0g/日（1回2.0g×3回）に設定
                        if (weight >= 40) {
                            // 直接結果を設定
                            document.getElementById('resultDose').innerHTML = '6.00 g';
                            document.getElementById('resultSingleDose').innerHTML = '2.00 g';
                            // 計算をスキップ
                            return;
                        }
                    }
                }
            }
            
            // 1日量を計算
            if (medicine.dailyDosePerKg) {
                // 1日量ベースの計算（タミフルなど）
                let dailyDoseG = medicine.dailyDosePerKg * weight;  // 1日量（g）
                
                // 最大投与量のチェック
                if (medicine.maxDailyDose && dailyDoseG > medicine.maxDailyDose) {
                    dailyDoseG = medicine.maxDailyDose;
                }
                
                const singleDoseG = dailyDoseG / medicine.frequency;  // 1回量（g）
                
                // 結果を表示
                document.getElementById('resultDose').innerHTML = `${dailyDoseG.toFixed(3)} g`;
                document.getElementById('resultSingleDose').innerHTML = `${singleDoseG.toFixed(3)} g`;
                document.getElementById('dosageInfo').textContent = `1日${medicine.frequency}回`;
            } else if (medicine.dailyDoseMultiplier) {
                // 1日量 = 乗数 × 体重(kg)
                dailyDoseG = medicine.dailyDoseMultiplier * weight;
                singleDoseG = dailyDoseG / medicine.frequency;
                
                // 結果を表示
                document.getElementById('resultDose').innerHTML = `${dailyDoseG.toFixed(2)} g`;
                document.getElementById('resultSingleDose').innerHTML = `${singleDoseG.toFixed(2)} g`;
                
            } else if (medicine.dailyDoseMg) {
                // 1日量が直接指定されている場合
                dailyDoseMg = medicine.dailyDoseMg;
                singleDoseMg = dailyDoseMg / medicine.frequency;
                
                // gに変換（含有率を考慮）
                dailyDoseG = (dailyDoseMg / 1000) / medicine.concentration;
                singleDoseG = (singleDoseMg / 1000) / medicine.concentration;
                
                // 結果を表示（直接指定）
                document.getElementById('resultDose').innerHTML = `${dailyDoseG.toFixed(2)} g`;
                document.getElementById('resultSingleDose').innerHTML = `${singleDoseG.toFixed(2)} g`;
            } else if (medicine.dosePerKg && medicine.unit === "mL") {
                // mL単位での計算（ムコダインシロップなど）
                const dailyDoseML = medicine.dosePerKg * weight;  // 1日量（mL）
                const singleDoseML = dailyDoseML / medicine.frequency;  // 1回量（mL）
                
                // 結果を表示（mL単位）
                document.getElementById('resultDose').innerHTML = `${dailyDoseML.toFixed(2)} mL`;
                document.getElementById('resultSingleDose').innerHTML = `${singleDoseML.toFixed(2)} mL`;
                document.getElementById('resultMedicine').textContent = medicine.name;
                
                // ザジテンシロップの場合は特別な用法表示
                if (medicineId === 'zaditen_syrup') {
                    document.getElementById('dosageInfo').textContent = `1日${medicine.frequency}回（朝食後・就寝前）`;
                } else {
                    document.getElementById('dosageInfo').textContent = `1日${medicine.frequency}回`;
                }
                
                // 禁忌情報を表示
                showContraindicationInfo(medicine);
                
                // 結果を表示
                resultDiv.style.display = 'block';
                return;
            } else if (medicine.dosePerKgG && medicine.unit === "g") {
                // g単位での直接計算（ムコダインDSなど）
                const dailyDoseG = medicine.dosePerKgG * weight;  // 1日量（g）
                const singleDoseG = dailyDoseG / medicine.frequency;  // 1回量（g）
                
                // 結果を表示（g単位）
                document.getElementById('resultDose').innerHTML = `${dailyDoseG.toFixed(2)} g`;
                document.getElementById('resultSingleDose').innerHTML = `${singleDoseG.toFixed(2)} g`;
                document.getElementById('resultMedicine').textContent = medicine.name;
                
                // ザジテンDSの場合は特別な用法表示
                if (medicineId === 'zaditen_ds') {
                    document.getElementById('dosageInfo').textContent = `1日${medicine.frequency}回（朝食後・就寝前）`;
                } else {
                    document.getElementById('dosageInfo').textContent = `1日${medicine.frequency}回`;
                }
                
                // 禁忌情報を表示
                showContraindicationInfo(medicine);
                
                // 結果を表示
                resultDiv.style.display = 'block';
                return;
            } else if (medicine.minDosePerKg === medicine.maxDosePerKg) {
                // 1日量に幅がない場合（単一値）
                dailyDoseMg = medicine.minDosePerKg * weight;
                
                // gに変換（含有率を考慮）
                dailyDoseG = (dailyDoseMg / 1000) / medicine.concentration;
                singleDoseG = (dailyDoseMg / 1000 / medicine.frequency) / medicine.concentration;
                
                // 1日量の上限をチェック（オノンDS10%など）
                if (medicineId === 'onon') {
                    const maxDailyDoseG = 4.5;  // 1日量の最大値 4.5g
                    if (dailyDoseG > maxDailyDoseG) {
                        dailyDoseG = maxDailyDoseG;
                        singleDoseG = dailyDoseG / medicine.frequency;
                    }
                }
                
                // 1日量の上限をチェック（ゾビラックスまたはバルトレックスで単純疱疹の場合）
                if ((medicineId === 'zovirax' || medicineId === 'valtrex') && 
                    document.getElementById('indication').value === 'herpesSimplex' &&
                    medicine.maxDailyDoseG) {
                    
                    // バルトレックスまたはゾビラックスで、体重が閾値以上の場合、1日量を固定値に設定
                    if ((medicineId === 'valtrex' && weight >= (medicine.maxWeightForDose || 0)) ||
                        (medicineId === 'zovirax' && weight >= (medicine.maxWeightForDose || 0))) {
                        dailyDoseG = medicine.maxDailyDoseG;
                    } else if (medicine.maxDailyDoseG) {
                        // それ以外は通常通り上限チェック
                        dailyDoseG = Math.min(dailyDoseG, medicine.maxDailyDoseG);
                    }
                    singleDoseG = dailyDoseG / medicine.frequency;
                }
                
                // 結果を表示（単一値）
                document.getElementById('resultDose').innerHTML = `${dailyDoseG.toFixed(2)} g`;
                document.getElementById('resultSingleDose').innerHTML = `${singleDoseG.toFixed(2)} g`;
            } else {
                // 1日量に幅がある場合
                const minDailyDoseMg = medicine.minDosePerKg * weight;
                const maxDailyDoseMg = medicine.maxDosePerKg * weight;
                const minSingleDoseMg = minDailyDoseMg / medicine.frequency;
                const maxSingleDoseMg = maxDailyDoseMg / medicine.frequency;
                
                // gに変換（含有率を考慮）
                let minDailyDoseG = (minDailyDoseMg / 1000) / medicine.concentration;
                let maxDailyDoseG = (maxDailyDoseMg / 1000) / medicine.concentration;
                let minSingleDoseG = (minSingleDoseMg / 1000) / medicine.concentration;
                let maxSingleDoseG = (maxSingleDoseMg / 1000) / medicine.concentration;
                
                // 1日量の上限をチェック（オノンDS10%など）
                if (medicineId === 'onon' && medicine.maxDailyDose) {
                    const maxDailyDoseG_limit = medicine.maxDailyDose;  // 1日量の最大値 4.5g
                    if (maxDailyDoseG > maxDailyDoseG_limit) {
                        maxDailyDoseG = maxDailyDoseG_limit;
                        maxSingleDoseG = maxDailyDoseG / medicine.frequency;
                    }
                }
                
                // 結果を表示（範囲）
                document.getElementById('resultDose').innerHTML = 
                    `${minDailyDoseG.toFixed(2)} - ${maxDailyDoseG.toFixed(2)} g`;
                document.getElementById('resultSingleDose').innerHTML = 
                    `${minSingleDoseG.toFixed(2)} - ${maxSingleDoseG.toFixed(2)} g`;
            }
            
            // 薬剤名と用法を表示
            document.getElementById('resultMedicine').textContent = medicine.name;
            
            // ザジテンの場合は特別な用法表示
            if (medicineId === 'zaditen_ds' || medicineId === 'zaditen_syrup') {
                document.getElementById('dosageInfo').textContent = `1日${medicine.frequency}回（朝食後・就寝前）`;
            } else {
                document.getElementById('dosageInfo').textContent = `1日${medicine.frequency}回`;
            }
            
            // カロナール細粒20%の場合は追記
            if (medicineId === 'carnal20') {
                document.getElementById('dosageInfo').textContent = `1日${medicine.frequency}回（1日最大0.3g/kg）`;
            }
            
            // カロナール細粒50%の場合は追記
            if (medicineId === 'carnal50') {
                document.getElementById('dosageInfo').textContent = `1日${medicine.frequency}回（1日最大0.12g/kg）`;
            }
            
            // アセトアミノフェンDS40%の場合は追記
            if (medicineId === 'acetaminophen') {
                document.getElementById('dosageInfo').textContent = `1日${medicine.frequency}回（1日最大0.15g/kg）`;
            }
            
            // ジスロマック細粒小児用10%の場合は追記
            if (medicineId === 'zithromax') {
                document.getElementById('dosageInfo').textContent = `1日${medicine.frequency}回（${medicine.dosageNote}）`;
            }
            
            // 禁忌情報を表示
            showContraindicationInfo(medicine);
            
            // 結果を表示
            resultDiv.style.display = 'block';
        }
    </script>
    
    <!-- サービスワーカー登録 -->
    <script src="register-sw.js"></script>
</body>
</html>
